<% provide(:title, "給与管理") %>

<div class="container">
  <div class="col-md-11 col-md-offset-0">
    <br>
    <%= form_with method: :get, local: true do |f| %>
      <%= f.label :name, "スタッフ検索" %>
      <div class="year-month-day-label">
        <%= f.label :day, "年月日検索" %>
      </div>
      <br>
      <div class="staff-select-field">
        <%= f.collection_select :user_id, @staffs, :id, :name, {prompt: "スタッフを選択"}, {class: "form-control"} %>
      </div>
      <div class="day-label">
        <%= f.date_field :day, class: "form-control" %>
      </div>
      <br>
      <br>
      <%= f.label :day, "年月検索" %>
      <br>
      <div class="year-month-select-field">
        <%= f.date_select :day, {:discard_day => true, :include_blank => true, :start_year => Time.now.year, :end_year => Time.now.year+200},
            class: "form-control" %>
      </div>
      <div class="indicate-btn">
        <%= f.submit "表示する", class: "btn btn-lg btn-primary" %>
      </div>
    <% end %>

    <% if params[:day].present? || params[:user_id].present? %>
      <% if @attendances.count > 0  %>
          <table class="table table-bordered table-condensed table-striped">
            <thead>
              <tr>
                <th class="salary-management-table">年月日</th>
                <th class="salary-management-table">スタッフ名</th>
                <th class="salary-management-table">出勤時間</th>
                <th class="salary-management-table">退勤時間</th>
                <th class="salary-management-table">休憩開始時間</th>
                <th class="salary-management-table">休憩終了時間</th>
                <th class="salary-management-table">日給</th>
              </tr>
            </thead>
              <% @attendances.each do |at| %>
                <tbody>
                  <tr>
                    <td class="center"><%= l(at.day.to_date, format: :long) %></td>
                    <td class="center"><%= at.user.name %></td>
                    <td class="center"><%= l(at.work_start_time.floor_to(15.minutes), format: :time) if at.work_start_time.present? %></td>
                    <td class="center"><%= l(at.work_end_time.floor_to(15.minutes), format: :time) if at.work_end_time.present? %></td>
                    <% if at.break_start_time.present? %>
                      <td class="center"><%= l(at.break_start_time, format: :time) %></td>
                    <% else %>
                      <td class="center"></td>
                    <% end %>
                    <% if at.break_end_time.present? %>
                      <td class="center"><%= l(at.break_end_time, format: :time) %></td>
                    <% else %>
                      <td class="center"></td>
                    <% end %>
                    <td class="center"><%= at.salary if at.salary.present? %></td>
                  </tr>
                </tbody>
                <% if at.work_start_time.present? && at.break_start_time.present? && at.break_end_time.present? && at.work_end_time.present? %>
                  <% if !(at.work_start_time.hour >= 22 && at.work_start_time.hour <= 24) && (at.work_end_time.hour >= 22 && at.work_end_time.hour <= 24) %>
                    <% non_overtime_day_hourly_wage = (22.0 - ((at.break_end_time.min / 60.0) - (at.break_start_time.min / 60.0)) - (at.work_start_time.hour + (at.work_start_time.floor_to(15.minutes).min / 60.0))).to_f * at.user.hourly_wage.to_f %>
                    <% if at.work_start_time.hour >= 22 && at.work_start_time.hour <= 24 %>
                      <% day_hourly_wage = total_time(at.work_start_time.floor_to(15.minutes), at.break_start_time, at.break_end_time, at.work_end_time.floor_to(15.minutes)).to_f * at.user.hourly_wage.to_f * 1.25 %>
                      <% @total_overtime_hourly_wage = @total_overtime_hourly_wage.to_i + day_hourly_wage.to_i %>
                    <% else %>
                      <% overtime_hourly_wage = ((at.work_end_time.hour + (at.work_end_time.floor_to(15.minutes).min / 60.0)).to_f  - 22.0) * at.user.hourly_wage.to_f * 1.25 %>
                      <% @total_overtime_hourly_wage = @total_overtime_hourly_wage.to_i + non_overtime_day_hourly_wage.to_i + overtime_hourly_wage.to_i %>
                    <% end %>
                  <% elsif !(at.work_start_time.hour >= 0 && at.work_start_time.hour <= 3) && (at.work_end_time.hour >= 0 && at.work_end_time.hour <= 3)  %>
                    <% non_overtime_day_hourly_wage = (22.0 - ((at.break_end_time.min / 60.0) - (at.break_start_time.min / 60.0)) - (at.work_start_time.hour + (at.work_start_time.floor_to(15.minutes).min / 60.0))).to_f * at.user.hourly_wage.to_f %>
                    <% if at.work_start_time.hour >= 22 && at.work_start_time.hour <= 24 %>
                      <% day_hourly_wage = total_time(at.work_start_time.floor_to(15.minutes), at.break_start_time, at.break_end_time, at.work_end_time.floor_to(15.minutes)).to_f * at.user.hourly_wage.to_f * 1.25 %>
                      <% @total_tomorrow_overtime_hourly_wage = @total_tomorrow_overtime_hourly_wage.to_i + day_hourly_wage.to_i %>
                    <% else %>
                      <% tomorrow_overtime_hourly_wage = (at.work_end_time.hour + (at.work_end_time.floor_to(15.minutes).min / 60.0) - 22.0 + 24.0).to_f * at.user.hourly_wage.to_f * 1.25 %>
                      <% @total_tomorrow_overtime_hourly_wage = @total_tomorrow_overtime_hourly_wage.to_i + non_overtime_day_hourly_wage.to_i + tomorrow_overtime_hourly_wage.to_i %>
                    <% end %>
                  <% else %>
                    <% day_hourly_wage = total_time(at.work_start_time.floor_to(15.minutes), at.break_start_time, at.break_end_time, at.work_end_time.floor_to(15.minutes)).to_f * at.user.hourly_wage.to_f %>
                    <% @total_non_overtime_hourly_wage = @total_non_overtime_hourly_wage.to_i + day_hourly_wage.to_i %>
                  <% end %>
                <% end %>
              <% end %>
          </table>
    
          <table class="table table-bordered table-condensed table-striped">
            <thead>
              <tr>
                <th class="salary-management-table">給与合計</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="center"><%= @total_overtime_hourly_wage.to_i + @total_tomorrow_overtime_hourly_wage.to_i + @total_non_overtime_hourly_wage.to_i %></td>
              </tr>
            </tbody>
          </table>
      <% else %>
        <h4>給与データはありません</h4>
      <% end %>
    <% end %>
  </div>
</div>